@inject IToastService toastService;
@inject IAccountService accountService;
@inject ILogger<Program> logger;

<div class="relative grow p-6 bg-white rounded-lg border border-@global.themeInfo.MainColor m-10">
    <div class="flex justify-between items-center mb-4">
        <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white">Money pot</h5>
        @if (!MoneyPotItem.IsFinished)
        {
            <span class="bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-green-200 dark:text-green-900">Open</span>
        }
        else
        {
            <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-indigo-200 dark:text-indigo-900">Close</span>
        }
    </div>
    <strong class="mb-2">
        <div>Creator :</div>
        <MPPopover>
            <TogglePopoverContent>
                <span class="bg-blue-100 text-blue-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">
                    @MoneyPotItem.Creator.Name
                </span>
            </TogglePopoverContent>
            <PopoverContent>
                <AccountCard account="@MoneyPotItem.Creator" />
            </PopoverContent>
        </MPPopover>
    </strong>
    <div class="mb-2 font-semibold">
        <div>Receiver :</div>
        
        <MPPopover>
            <TogglePopoverContent>
                <span class="bg-blue-100 text-blue-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">
                    @MoneyPotItem.Receiver.Name
                </span>
            </TogglePopoverContent>
            <PopoverContent>
                <AccountCard account="@MoneyPotItem.Creator" />
            </PopoverContent>
        </MPPopover>
    </div>
    <div class="mb-3 font-semibold">
        <div>Contributors :</div>

        <MPList Elems="@MoneyPotItem.Contributors"
                Context="contributor">
            <ElemsContent>
                <MPPopover>
                    <TogglePopoverContent>
                        <span class="bg-blue-100 text-blue-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">
                            @contributor.Contributor.Name
                        </span>
                    </TogglePopoverContent>
                    <PopoverContent>
                        <AccountCard account="@contributor.Contributor" />
                    </PopoverContent>
                </MPPopover>
            </ElemsContent>
        </MPList>
    </div>
    @if (!MoneyPotItem.IsFinished)
    {
        <div class="flex justify-between items-end">
            <Modal Valid="Ok"
               Cancel="" @ref="ContributionModal">
                <ToggleModalContent>Contribute !</ToggleModalContent>
                <ModalContent>
                    <ContributeForm OnMoneyPotContribution="OnMoneyPotContribution" />
                </ModalContent>
            </Modal>
        </div>
    }
</div>

@code {
    [CascadingParameter] protected MainLayout.GlobalInformation? global { get; set; }
    [Parameter] public MoneyPotDto? MoneyPotItem { get; set; }
    private Modal ContributionModal { get; set; } = new();
    public ContributorDto? CurrentContributor { get; set; }

    protected override void OnInitialized()
    {
        if(MoneyPotItem == null)
            throw new ArgumentNullException("Please provide a money pot as parameter");
    }

    protected void OnMoneyPotContribution(ContributorDto CurrentContributor)
    {
        logger.LogInformation($"Contribution of {CurrentContributor.Contributor.Name} from {CurrentContributor.Amount} ok !");
        
        ContributionModal.Hide();
        toastService.ShowSuccess("Your contribution has been added !");
    }
}